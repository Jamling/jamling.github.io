<!doctype html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="//cdn.staticfile.org/jquery/2.2.0/jquery.min.js"></script>
<link rel="alternate" href="/atom.xml" title="Jamling's Blog and Project Site" type="application/atom+xml">
</head><body>
    
</body>
<!-- LeanClound官方Javascript SDK -->
<script>
    var page_layout = 'false'
    var lc_debug = true;
  
    var lc_config = {
      xid : '{{page_uid()}}',
      url : '{{page.path}}' || '{{page.permalink}}',
      title : '{{page_title()}}'
    };
    lc_debug && console.log('lcconfig', lc_config);
  
    var lc_table = 'Counter';
  
    function lc_page_views() {
      var query = new AV.Query(lc_table);
      //query.select(['-ACL']);
      query.equalTo('xid', lc_config.xid);
      query.find().then(results => {
          // results is an array of AV.Object.
          if (typeof results === 'undefined' || results.length == 0) {
            insert();
            return;
          }
          update(results);
          show(results);
        });
  
      function insert(data) {
          lc_debug && console.log('data is null new object');
          var M = AV.Object.extend(lc_table);
          var data = new M();
          data.set('time', 1);
        for ( var key in lc_config) {
          data.set(key, lc_config[key]);
        }
        data.save().then(function(data) {
          lc_debug && console.log('created objectId is ' + data.id);
        }, function(error) {
          lc_debug && console.log("create object failed", error);
        });
      }
  
      function update(data) {
        for ( var key in lc_config) {
          if (key !== 'xid')
          data.set(key, lc_config[key]);
        }
        lc_debug && console.log("after change,data", data);
        data.increment('time', 1);
        data.save().then(function(data) {
          lc_debug && console.log("update to " + data.get('time'));
        }, function(error) {
          lc_debug && console.log("update object failed", error);
        });
      }
  
      function show(data) {
        $(".lc-count").html(data.get('time'));
      }
      function show_count(count) {
        $(".lc-count").html(count);
      }
    };
  
    function lc_index_views() {
      // load views count from leanclound
      // make sure you are created Counter table on leanclound
      function lc_load_views(selector, options) {
        var o = options || {};
        var tkeys = [];
        $(selector).each(function(i) {
          var tkey = $(this).data('tkey');
          tkeys.push(tkey);
        });
  
        var query = new AV.Query(lc_table);
        query.select([ '-ACL', '-createdAt', '-updatedAt', '-url' ]);
        query.containedIn('xid', tkeys);
        query.find().then(function(results) {
          $(selector).each(function(i) {
            var tkey = $(this).data('tkey');
            for (var i = 0; i < results.length; i++) {
              var t = results[i];
              if (t.get('xid') === tkey) {
                var c = t.get('time') + '';
                $(this).find(o.p.views).html(c);
              }
            }
          });
        }, function(error) {
        });
      }
  
      lc_load_views('.card-action', {
        style : 'hidden-xs',
        p : {
          views : '.nova-eye .count'
        }
      });
    }
    if(typeof AV === 'undefined') {
      $.getScript('//unpkg.com/leancloud-storage@4.13.2/dist/av-min.js',function() {
        lc_debug && console.log('init AV after av.js loaded');
          AV.init({
            appId : 'C45xzaBLva5G5IfKxOwGXuVb-gzGzoHsz',
            appKey : 'QwGBjKlSYOBtjMa5aTGeO3cb',
            serverURLs : 'https://lc.ieclipse.cn'
          });
          if (page_layout === 'true') {
            lc_index_views('.card-action', {
              style : 'hidden-xs',
              p : {
                views : '.nova-eye .count'
              }
            })
          }
          lc_page_views();
      });
    } else {
      lc_page_views();
    }
  </script>
</html>
